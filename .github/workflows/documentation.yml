name: Documentation

on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]
  
jobs:
  make-documentation:
    runs-on: ubuntu-latest
    steps:
    
      - name: Pull sopt docker
        # is it better to use premade actions like:
        uses: docker://uclrits/sopt
        # or just run the commands like:
        #run: docker pull uclrits/sopt
        
      - name: Give write permission
        run: chmod o+w . #do we need this? Yep
        
      - name: Build sopt docs  
        run: docker run --rm -v $(pwd):/mydata uclrits/sopt /bin/sh -c "mkdir build; cd build; cmake .. -Ddocs=ON -Dweb=ON; eval 'make docweb VERBOSE=1'"
        
      - name: Check out Purify
        uses: actions/checkout@v2

      - name: Install purify dependencies
        run: sudo apt install libfftw3-dev libtiff5-dev openmpi-bin libopenmpi-dev libboost-all-dev libeigen3-dev libyaml-cpp-dev ccache libcfitsio-dev casacore-dev
        
        # This is straight from Travis, can make it shorter like Tuomas's GHA?  
      - name: Configure
        run: | 
          cmake .. -DCMAKE_BUILD_TYPE=Release \
          -Dtests=${Tests-ON} \
          -Ddompi=OFF \
          -Dexamples=${EXAMPLES-OFF} \
          -Dopenmp=OFF \
          -Ddocs=ON \
          -Ddocasa=${CASA-OFF} \
          -Dbenchmarks=${Benchmarks-OFF} \
          -Dcoverage=${COVERAGE-OFF} \
          -DPURIFY_TEST_LOG_LEVEL=${test_level-critical} \
          -DGreatCMakeCookOff_DIR:PATH=/tmp/GreatCMakeCookOff/cmake \
          -DCFitsIO_URL=https://github.com/UCL-RITS/BinaryBlobs-dependencies/raw/master/Astronomy/cfitsio3410.tar.gz 
        
      - name: build
        run: make docweb VERBOSE=1
        
      - name: test # do we need to do this step?
        run: ctest -T test --output-on-failure -V
        
      #- name: Deploy to GH pages   

